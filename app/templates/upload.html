<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Food Ingredient Detector &amp; Recipe Recommender</title>
    <style>
      table { border-collapse: collapse; width: 100%; margin-top: 1em; }
      th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; vertical-align: top; }
      th { background: #f4f4f4; }
      ul, ol { margin: 0; padding-left: 1.2em; }
      .recipe-table { margin-bottom: 2em; }
    </style>
</head>
<body>
    <h1>Food Ingredient Detector &amp; Recipe Recommender</h1>

    <form id="upload-form" action="/predict" enctype="multipart/form-data" method="post">
        <input name="file" type="file" accept="image/*" required>
        <input type="submit" value="Detect Ingredients">
    </form>

    {% if predictions %}
    <h2>Detected Ingredients:</h2>
    <ul id="prediction-list">
        {% for label, confidence in predictions %}
            <li>{{ label }} ({{ '{:.2f}'.format(confidence * 100) }}% confidence)</li>
        {% endfor %}
    </ul>

    <script>
    window.lastIngredients = [
        {% for label, confidence in predictions %}
            "{{ label }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    </script>
    <button id="recommend">Get Recipes</button>
    <span id="loading" style="display:none; margin-left:1em;">Loadingâ€¦</span>
    {% endif %}

    <h2>Recipes</h2>
    <div id="recipes"></div>

    <script>
    const btn = document.getElementById('recommend');
    const loader = document.getElementById('loading');
    const container = document.getElementById('recipes');

    btn?.addEventListener('click', async () => {
        const ings = window.lastIngredients || [];
        if (!ings.length) {
            alert('Please detect ingredients first!');
            return;
        }

        // show loader + disable button
        loader.style.display = 'inline';
        btn.disabled = true;
        container.innerHTML = '';  // clear previous

        try {
            const res = await fetch('/recommend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ings)
            });
            if (!res.ok) throw new Error(`Status ${res.status}`);
            const { recipes } = await res.json();

            if (!recipes || recipes.length === 0) {
                container.textContent = 'No recipes found.';
            } else {
                // Build table
                const table = document.createElement('table');
                table.classList.add('recipe-table');
                table.innerHTML = `
                  <thead>
                    <tr>
                      <th>Name</th><th>Ingredients</th><th>Steps</th><th>Time (min)</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${recipes.map(r => `
                      <tr>
                        <td>${r.name}</td>
                        <td><ul>${r.ingredients.map(i => `<li>${i}</li>`).join('')}</ul></td>
                        <td><ol>${r.steps.map(s => `<li>${s}</li>`).join('')}</ol></td>
                        <td>${r.time_minutes}</td>
                      </tr>
                    `).join('')}
                  </tbody>`;
                container.appendChild(table);
            }
        } catch (err) {
            console.error(err);
            alert('Failed to fetch recipes. See console for details.');
        } finally {
            // hide loader + re-enable button
            loader.style.display = 'none';
            btn.disabled = false;
        }
    });
    </script>
</body>
</html>
